on: [push]
jobs:
  package:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '16'
      - name: Install packages
        run: npm install
      - name: Lint
        run: npm run lint

      - name: Install packaging dependencies
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install zip gh

      - name: Package for Chrome
        run: |
          mkdir -p dist/chrome
          cp -r src icons manifest_v3.json license.md dist/chrome
          cd dist/chrome
          mv manifest_v3.json manifest.json
          zip -r ../chrome-build-$(git rev-parse --short HEAD).zip .
          cd ..
          rm -rf chrome
      - name: Package for Firefox
        run: |
          mkdir -p dist/firefox
          cp -r src icons manifest_v2.json license.md dist/firefox
          cd dist/firefox
          mv manifest_v2.json manifest.json
          zip -r ../firefox-build-$(git rev-parse --short HEAD).zip .
          cd ..
          rm -rf firefox

      - name: Publish assets
        run:
          gh release list
